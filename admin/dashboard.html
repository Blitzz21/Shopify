<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - GameDayTees</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Admin Dashboard - Print Station</h1>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                    Logout
                </button>
            </div>
        </div>
    </header>
    
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Welcome Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Welcome to the Print Station!</h2>
            <p class="text-gray-600">You are successfully logged in as an administrator.</p>
            <div class="mt-4">
                <p id="userInfo" class="text-sm text-gray-500"></p>
            </div>
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800">Print Jobs</h3>
                    <p class="text-2xl font-bold text-blue-600">12</p>
                    <p class="text-sm text-blue-600">Pending</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800">Completed</h3>
                    <p class="text-2xl font-bold text-green-600">47</p>
                    <p class="text-sm text-green-600">Today</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-purple-800">Printers</h3>
                    <p class="text-2xl font-bold text-purple-600">3</p>
                    <p class="text-sm text-purple-600">Online</p>
                </div>
            </div>
        </div>

        <!-- Supplier Management Section -->
        <div id="supplierManagement" class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold mb-6 flex items-center">
                üè≠ Supplier Management
            </h2>
            
            <!-- Supplier List -->
            <div class="mb-8">
                <h3 class="text-lg font-medium mb-4">Current Suppliers</h3>
                <div id="suppliersList" class="space-y-3"></div>
                
                <!-- Add New Supplier Form -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-medium mb-3">Add New Supplier</h4>
                    <form id="addSupplierForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Supplier Name</label>
                                <input type="text" name="name" placeholder="e.g., SanMar" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Unique Code</label>
                                <input type="text" name="code" placeholder="e.g., sanmar" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
                                <input type="email" name="contact_email" placeholder="purchasing@supplier.com" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                <input type="text" name="phone" placeholder="+1 (555) 123-4567" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">API Base URL</label>
                                <input type="url" name="api_base_url" placeholder="https://api.supplier.com/v1" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <button type="submit" 
                                class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                            Add Supplier
                        </button>
                    </form>
                </div>
            </div>

            <!-- SKU Mappings Section -->
            <div class="mt-8">
                <h3 class="text-lg font-medium mb-4 flex items-center">
                    üì¶ Product SKU Mappings
                </h3>
                <div id="skuMappingsList" class="space-y-3 mb-6"></div>
                
                <!-- Add SKU Mapping Form -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-medium mb-3">Add SKU Mapping</h4>
                    <form id="addSkuMappingForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                                <select name="product_id" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Supplier</label>
                                <select name="supplier_id" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Select Supplier</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Supplier SKU</label>
                                <input type="text" name="supplier_sku" placeholder="e.g., PC61, G500" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Default Color</label>
                                <input type="text" name="default_color" placeholder="e.g., WHITE, BLACK" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Default Size</label>
                                <input type="text" name="default_size" placeholder="e.g., M, L, XL" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                            <textarea name="notes" placeholder="Additional notes about this mapping..." 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                      rows="3"></textarea>
                        </div>
                        <button type="submit" 
                                class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Add SKU Mapping
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = 'http://localhost/Shopify/backend/api';

        async function logout() {
            try {
                await fetch(`${API_BASE}/logout.php`, {
                    method: 'POST',
                    credentials: 'include',
                });
            } catch (e) {
                console.error('Logout API error:', e);
            }

            localStorage.removeItem('user');
            localStorage.removeItem('isLoggedIn');
            window.location.href = '/Shopify/login.html';
        }

        // Supplier Management Functions
        async function loadSuppliers() {
            try {
                const res = await fetch(`${API_BASE}/suppliers.php`, {
                    credentials: 'include'
                });
                const data = await res.json();
                
                if (data.success) {
                    displaySuppliers(data.data);
                    populateSupplierDropdown(data.data);
                }
            } catch (error) {
                console.error('Error loading suppliers:', error);
            }
        }

        async function loadSkuMappings() {
            try {
                const res = await fetch(`${API_BASE}/sku-mappings.php`, {
                    credentials: 'include'
                });
                const data = await res.json();
                
                if (data.success) {
                    displaySkuMappings(data.data);
                }
            } catch (error) {
                console.error('Error loading SKU mappings:', error);
            }
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${API_BASE}/get-products.php`, {
                    credentials: 'include'
                });
                const data = await res.json();
                
                if (data.success) {
                    populateProductDropdown(data.data);
                } else {
                    console.error('Failed to load products:', data.message);
                }
            } catch (error) {
                console.error('Error loading products:', error);
                // Create a fallback if products API doesn't exist yet
                populateProductDropdown([]);
            }
        }

        function displaySuppliers(suppliers) {
            const container = document.getElementById('suppliersList');
            if (suppliers.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No suppliers found. Add your first supplier above.</p>';
                return;
            }
            
            container.innerHTML = suppliers.map(supplier => `
                <div class="p-4 border-l-4 border-blue-500 bg-white rounded-lg shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <strong class="text-gray-900">${supplier.name}</strong> 
                            <span class="text-gray-600 text-sm ml-2">(${supplier.code})</span>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full ${supplier.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${supplier.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="mt-2 text-sm text-gray-600">
                        <div>üìß ${supplier.contact_email || 'No email'}</div>
                        <div>üìû ${supplier.phone || 'No phone'}</div>
                    </div>
                </div>
            `).join('');
        }

        function displaySkuMappings(mappings) {
            const container = document.getElementById('skuMappingsList');
            if (mappings.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No SKU mappings found. Add your first mapping above.</p>';
                return;
            }
            
            container.innerHTML = mappings.map(mapping => `
                <div class="p-4 border-l-4 border-green-500 bg-white rounded-lg shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <strong class="text-gray-900">${mapping.product_name}</strong> 
                            <span class="text-gray-600 text-sm mx-2">‚Üí</span>
                            <strong class="text-gray-900">${mapping.supplier_name}</strong>
                            <span class="text-gray-600 text-sm ml-2">(${mapping.supplier_sku})</span>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full ${mapping.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${mapping.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="mt-2 text-sm text-gray-600">
                        <div>üé® Color: ${mapping.default_color || 'Not specified'}</div>
                        <div>üìè Size: ${mapping.default_size || 'Not specified'}</div>
                        ${mapping.notes ? `<div class="mt-1 text-xs text-gray-500">üìù ${mapping.notes}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function populateSupplierDropdown(suppliers) {
            const dropdown = document.querySelector('select[name="supplier_id"]');
            dropdown.innerHTML = '<option value="">Select Supplier</option>' +
                suppliers.map(supplier => 
                    `<option value="${supplier.id}">${supplier.name} (${supplier.code})</option>`
                ).join('');
        }

        function populateProductDropdown(products) {
            const dropdown = document.querySelector('select[name="product_id"]');
            dropdown.innerHTML = '<option value="">Select Product</option>' +
                products.map(product => 
                    `<option value="${product.id}">${product.name}</option>`
                ).join('');
        }

        // Form Handlers
        document.getElementById('addSupplierForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const res = await fetch(`${API_BASE}/suppliers.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                
                if (result.success) {
                    alert('Supplier added successfully!');
                    e.target.reset();
                    loadSuppliers();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error adding supplier:', error);
                alert('Error adding supplier');
            }
        });

        document.getElementById('addSkuMappingForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const res = await fetch(`${API_BASE}/sku-mappings.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                
                if (result.success) {
                    alert('SKU mapping added successfully!');
                    e.target.reset();
                    loadSkuMappings();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error adding SKU mapping:', error);
                alert('Error adding SKU mapping');
            }
        });

        async function loadAdminDashboard() {
            try {
                const res = await fetch(`${API_BASE}/check-auth.php`, {
                    method: 'GET',
                    credentials: 'include',
                });

                const data = await res.json();

                if (!data.success || !data.data || data.data.role !== 'admin') {
                    localStorage.removeItem('user');
                    localStorage.removeItem('isLoggedIn');
                    window.location.href = '/Shopify/login.html';
                    return;
                }

                localStorage.setItem('user', JSON.stringify(data.data));
                localStorage.setItem('isLoggedIn', 'true');

                document.getElementById('userInfo').textContent =
                    `Logged in as: ${data.data.name} (${data.data.email}) - Role: ${data.data.role}`;

                // Load supplier management data
                loadSuppliers();
                loadSkuMappings();
                loadProducts();

            } catch (e) {
                console.error('check-auth failed:', e);
                localStorage.removeItem('user');
                localStorage.removeItem('isLoggedIn');
                window.location.href = '/Shopify/login.html';
            }
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', loadAdminDashboard);
    </script>
</body>
</html>